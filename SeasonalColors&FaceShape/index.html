<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>ä¸ªäººè‰²å½©ï¼ˆå­£èŠ‚å‹&è„¸å‹ï¼‰æŠ¥å‘Šç”Ÿæˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ä¾èµ–åº“ -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root { --baseW: 750; }

    * { box-sizing: border-box; }
    body{
      font-family: 'Microsoft YaHei', system-ui, -apple-system, "Segoe UI", Roboto, "PingFang SC", "Hiragino Sans GB", Arial, sans-serif;
      background:#f5f5f5; margin:0; padding:16px; color:#111;
    }

    /* å·¥å…·æ  */
    .toolbar{
      display:flex; flex-wrap:nowrap; justify-content:center; align-items:center;
      gap:5px; width:max-content; margin:0 auto 20px; transform:translateX(-118px);
    }
    .toolbar button, .toolbar label{
      display:inline-flex; align-items:center; justify-content:center;
      height:36px; padding:0 12px; min-width:110px; font-size:14px;
      background-color:#28a745; color:#fff; border:none; border-radius:8px; cursor:pointer;
    }
    .toolbar button:hover, .toolbar label:hover{ background-color:#218838; }
    .toolbar input[type=file]{ display:none; }

    /* ä¸¤æ  */
    .content{ display:flex; justify-content:center; align-items:flex-start; gap:16px; }
    .content > .stage, .content > .thumb{ flex:0 0 auto; }

    .thumb{ display:flex; flex-direction:column; align-items:center; gap:8px; min-width:220px; }

    /* ç”»å¸ƒå¤–å£³ & å†…å±‚ï¼ˆç¼©æ”¾ï¼‰ */
    .frame{ position:relative; width:0; height:0; margin:0 auto; overflow:hidden; border:1px solid #ddd; border-radius:8px; background:#fff; }
    .frameInner{ position:absolute; left:0; top:0; width:0; height:0; transform-origin:top left; }

    .bg{ position:absolute; left:0; top:0; width:100%; height:100%; object-fit:contain; pointer-events:none; user-select:none; }

    /* æ–‡æœ¬ç¼–è¾‘æ¡†ï¼ˆç»Ÿä¸€æ ·å¼ & å­—å·ï¼‰ */
    .field-input{
      position:absolute;
      line-height:76px;
      display:flex; align-items:center;         /* å‚ç›´å±…ä¸­ */
      padding:0 16px;
      background:transparent;
      border-radius:12px;
      font-size:38px;                            /* ğŸ‘ˆ è°ƒæ•´æ‰€æœ‰è¾“å…¥æ¡†å­—å· */
      color:#000; outline:none; font-family:inherit;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .field-input[contenteditable="true"]{ cursor:text; }
    .field-input[data-placeholder]:empty::before{ content: attr(data-placeholder); color:#b8b8b8; }

    /* ===== æ–°æ¨¡æ¿ï¼šä¸ªäººè‰²å½©å®šä½æŠ¥å‘Š â€”â€” è¾“å…¥æ¡†å®šä½ï¼ˆç™¾åˆ†æ¯”ï¼‰ =====
       è¿™äº›å€¼åŸºäº 750px å®½åŸºå‡†ä¼°ç®—ï¼Œå¦‚æœ‰ç»†å¾®åå·®ï¼Œå¾®è°ƒ top/left/width/height å³å¯ã€‚
    */
    .class  { top:9.6%; left:28.5%; width:57%; height:1.2%; }  /* ç­çº§ */
    .name   { top:11.34%; left:28.5%; width:57%; height:1.2%; }  /* å§“å */
    .season { top:13.05%; left:42%; width:44%; height:1.2%; }  /* å­£èŠ‚å‹å®šä½ */
    .face   { top:14.78%; left:37%; width:49%; height:1.2%; }  /* è„¸å‹å®šä½ */

    /* è¿›åº¦æ¡ */
    .progress{ position:fixed; left:50%; transform:translateX(-50%); bottom:20px; background:#fff; color:#333;
      padding:12px 16px; border-radius:10px; font-size:12px; display:none; z-index:1200;
      box-shadow:0 6px 24px rgba(0,0,0,.15); min-width:320px; text-align:left;
    }
    .progress .title{ font-weight:700; margin-bottom:6px; }
    .progress .bar{ width:100%; height:10px; background:#eee; border-radius:999px; overflow:hidden; }
    .progress .bar>div{ height:100%; width:0%; background:linear-gradient(90deg,#7c3aed,#a855f7); border-radius:999px; transition:width .15s ease; }
    .progress .desc{ margin-top:6px; font-size:12px; color:#666; }

    #resultThumb{ max-width:220px; border:1px solid #ccc; border-radius:8px; display:none; cursor:pointer; background:#fff; }

    /* è¾…åŠ©ï¼šæŒ‰ D é”®åˆ‡æ¢è™šçº¿æ¡†ï¼Œæ–¹ä¾¿å¾®è°ƒå¯¹é½ */
    .debug-on .field-input{ outline:1px dashed rgba(0,0,0,.35); }
  </style>
</head>
<body>
  <!-- å·¥å…·æ  -->
  <div class="toolbar">
    <button id="downloadTplXlsx">ä¸‹è½½æ¨¡æ¿è¡¨æ ¼</button>
    <label for="dataFile">ä¸Šä¼ æ•°æ®æ–‡ä»¶</label>
    <input id="dataFile" type="file" accept=".csv,.xlsx,.xls" />
    <button id="batchGen">å¼€å§‹æ‰¹é‡ç”Ÿæˆ</button>
    <button id="singlePreviewBtn">ç”Ÿæˆå•ä¸ªï¼ˆé¢„è§ˆï¼‰</button>
  </div>

  <!-- è¿›åº¦æ¡ -->
  <div id="prog" class="progress">
    <div class="title">æ‰¹é‡ç”Ÿæˆè¿›åº¦</div>
    <div class="bar"><div id="progFill"></div></div>
    <div class="desc" id="progText">å‡†å¤‡å¼€å§‹â€¦</div>
  </div>

  <!-- ä¸¤æ  -->
  <div class="content">
    <div class="stage" id="stage">
      <div class="frame" id="frame">
        <div class="frameInner" id="frameInner">
          <!-- èƒŒæ™¯å›¾ï¼šæŠŠæ–‡ä»¶åæ¢æˆä½ çš„å®é™…æ–‡ä»¶ -->
          <img class="bg" id="bgImg" src="å­£èŠ‚å‹+è„¸å‹æœ€æ¸…æ™°.jpg" alt="èƒŒæ™¯" />

          <!-- è¾“å…¥æ¡†ï¼ˆå¯ç¼–è¾‘ï¼‰ -->
          <div class="field-input class"  id="class"  contenteditable="true" data-placeholder="ç­çº§"></div>
          <div class="field-input name"   id="name"   contenteditable="true" data-placeholder="å§“å"></div>
          <div class="field-input season" id="season" contenteditable="true" data-placeholder="å­£èŠ‚å‹å®šä½"></div>
          <div class="field-input face"   id="face"   contenteditable="true" data-placeholder="è„¸å‹å®šä½"></div>
        </div>
      </div>
    </div>

    <div class="thumb">
      <div style="font-size:14px;color:#555;">å•ä¸ªç”Ÿæˆç¼©ç•¥å›¾ï¼ˆå³é”®å¤åˆ¶/ä¿å­˜ï¼‰</div>
      <img id="resultThumb" alt="é¢„è§ˆç¼©ç•¥å›¾" />
    </div>
  </div>

  <script>
    function safeName(s){ return String(s||'').trim().replace(/[\\/:*?"<>|]/g,'_').slice(0,60) || 'report'; }

    /* ä¸‹è½½ Excel æ¨¡æ¿ â€”â€” å››åˆ—è¡¨å¤´ */
    document.getElementById('downloadTplXlsx').addEventListener('click', () => {
      const headers = [[ 'ç­çº§','å§“å','å­£èŠ‚å‹å®šä½','è„¸å‹å®šä½' ]];
      const ws = XLSX.utils.aoa_to_sheet(headers);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'æ¨¡æ¿');
      const buf = XLSX.write(wb, { bookType:'xlsx', type:'array' });
      saveAs(new Blob([buf], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}), 'å­£èŠ‚è‰²å½©+è„¸å‹-æ¨¡æ¿.xlsx');
    });

    /* ===== DOM å¼•ç”¨ ===== */
    const stage      = document.getElementById('stage');
    const frame      = document.getElementById('frame');
    const frameInner = document.getElementById('frameInner');
    const bgImg      = document.getElementById('bgImg');
    const reportForShot = frameInner;

    /* ===== åŸºå‡†å°ºå¯¸ä¸ç¼©æ”¾ ===== */
    let baseW = 750, baseH = 1000;
    let scale = 1, zoomScale = 2.52;

    function layoutByFrame(){
      if(!baseW || !baseH) return;
      const availW = Math.max(320, window.innerWidth - 32);
      const maxH   = window.innerHeight * 0.92;
      const kW = availW / baseW;
      const kH = maxH   / baseH;
      scale = Math.min(1, kW, kH);
      const finalScale = scale * zoomScale;
      frame.style.width  = (baseW * finalScale) + 'px';
      frame.style.height = (baseH * finalScale) + 'px';
      frameInner.style.width  = baseW + 'px';
      frameInner.style.height = baseH + 'px';
      frameInner.style.transform = `scale(${finalScale})`;
      stage.style.width = frame.style.width;
    }

    bgImg.onload = () => {
      baseW = bgImg.naturalWidth  || bgImg.width  || baseW;
      baseH = bgImg.naturalHeight || bgImg.height || baseH;
      layoutByFrame();
    };
    if (bgImg.complete) bgImg.onload();

    let _rf; window.addEventListener('resize', ()=>{ cancelAnimationFrame(_rf); _rf = requestAnimationFrame(layoutByFrame); });

    /* Ctrl+æ»šè½®ç¼©æ”¾ */
    window.addEventListener('wheel', (e)=>{
      if (e.ctrlKey){
        e.preventDefault();
        const factor = 1.1;
        zoomScale = e.deltaY < 0 ? zoomScale * factor : zoomScale / factor;
        zoomScale = Math.min(Math.max(zoomScale, 0.2), 5);
        layoutByFrame();
      }
    }, { passive:false });

    /* ===== ç”Ÿæˆç”»å¸ƒï¼ˆCORS å®‰å…¨å¤„ç†ï¼‰ ===== */
    async function ensureSafeImageURL(imgEl){
      let s = imgEl?.src || '';
      if (!s) throw new Error('å°šæœªé€‰æ‹©æ¨¡æ¿å›¾ç‰‡ã€‚');
      try {
        const u = new URL(s, location.href);
        const same = u.origin === location.origin;
        if (s.startsWith('blob:') || s.startsWith('data:') || same) return s;
      } catch(_) {}
      return await new Promise((res, rej) => {
        const t = new Image(); t.crossOrigin = 'anonymous';
        t.onload = () => {
          try {
            const c = document.createElement('canvas');
            c.width = t.naturalWidth; c.height = t.naturalHeight;
            c.getContext('2d').drawImage(t,0,0);
            res(c.toDataURL('image/png'));
          } catch(e){ rej(e); }
        };
        t.onerror = () => rej(new Error('æ¨¡æ¿å›¾ç‰‡æ— æ³•è½¬ä¸ºå®‰å…¨æ¥æºã€‚'));
        t.src = s;
      });
    }

    async function renderToCanvas(){
      const safeURL = await ensureSafeImageURL(bgImg);
      return await html2canvas(reportForShot, {
        scale: 2, useCORS: true, allowTaint: false, backgroundColor: null,
        onclone: (doc) => {
          const clonedImg = doc.getElementById('bgImg');
          if (clonedImg) clonedImg.src = safeURL;
        }
      });
    }

    async function canvasToBlobSafe(canvas){
      return await new Promise((resolve)=>{
        if (canvas.toBlob){ canvas.toBlob(b=>resolve(b)); }
        else{
          const dataURL = canvas.toDataURL('image/png');
          const byteString = atob(dataURL.split(',')[1]);
          const len = byteString.length; const u8 = new Uint8Array(len);
          for (let i=0;i<len;i++) u8[i] = byteString.charCodeAt(i);
          resolve(new Blob([u8], {type:'image/png'}));
        }
      });
    }

    /* å•ä¸ªé¢„è§ˆ */
    document.getElementById('singlePreviewBtn').addEventListener('click', async () => {
      try {
        const canvas = await renderToCanvas();
        const dataURL = canvas.toDataURL('image/png');
        const thumb = document.getElementById('resultThumb');
        thumb.src = dataURL; thumb.style.display = 'block';
      } catch (e) { console.error(e); alert('ç”Ÿæˆå¤±è´¥ï¼š' + e.message); }
    });

    /* è¯»å–æ•°æ®æ–‡ä»¶ï¼ˆCSV / Excelï¼‰ */
    let dataRows = [];
    document.getElementById('dataFile').addEventListener('change', async (e)=>{
      try {
        const file = e.target.files[0]; if(!file) return;
        const name = file.name.toLowerCase();
        if (name.endsWith('.csv')){
          const text = await file.text();
          const parsed = Papa.parse(text, { header:true, skipEmptyLines:true });
          dataRows = parsed.data;
        } else if (name.endsWith('.xlsx') || name.endsWith('.xls')){
          const buf = await file.arrayBuffer();
          const wb = XLSX.read(buf, { type:'array' });
          const sheet = wb.Sheets[wb.SheetNames[0]];
          dataRows = XLSX.utils.sheet_to_json(sheet);
        } else { alert('ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹ï¼Œè¯·é€‰æ‹© CSV æˆ– Excel'); return; }
        alert('å·²è¯»å– ' + dataRows.length + ' è¡Œæ•°æ®');
      } catch(err){ console.error(err); alert('è¯»å–è¡¨æ ¼å¤±è´¥ï¼š' + err.message); }
    });

    /* æ‰¹é‡ç”Ÿæˆ â€”â€” æ˜ å°„å››ä¸ªå­—æ®µ */
    document.getElementById('batchGen').addEventListener('click', async ()=>{
      if (!dataRows.length){ alert('è¯·å…ˆé€‰æ‹© CSV/Excel æ•°æ®æ–‡ä»¶'); return; }
      try { await ensureSafeImageURL(bgImg); } catch(e){ alert(e.message); return; }

      const panel = document.getElementById('prog');
      const fill  = document.getElementById('progFill');
      const text  = document.getElementById('progText');
      const setProgress = (p,msg)=>{ panel.style.display='block'; fill.style.width = Math.max(0,Math.min(100,p))+'%'; text.textContent = msg||''; };

      try {
        setProgress(2,'å‡†å¤‡å¼€å§‹â€¦');
        const zip = new JSZip();

        const pick = (obj, keys)=>{ for(const k of keys){ if(obj[k]!=null && obj[k] !== '') return obj[k]; } return ''; };

        for(let i=0;i<dataRows.length;i++){
          const row = dataRows[i];

          document.getElementById('class').textContent  = pick(row, ['ç­çº§','class','Class']);
          document.getElementById('name').textContent   = pick(row, ['å§“å','name','Name']);
          document.getElementById('season').textContent = pick(row, ['å­£èŠ‚å‹å®šä½','å­£èŠ‚','è‰²å½©','season']);
          document.getElementById('face').textContent   = pick(row, ['è„¸å‹å®šä½','è„¸å‹','face']);

          await new Promise(r=>requestAnimationFrame(r));
          const canvas = await renderToCanvas();
          const blob   = await canvasToBlobSafe(canvas);
          const filename = safeName(row['å§“å'] || ('report_'+(i+1))) + '.png';
          zip.file(filename, blob);

          const pct = Math.round(((i+1)/dataRows.length)*85);
          setProgress(pct, `æ¸²æŸ“å›¾ç‰‡ï¼š${i+1}/${dataRows.length}`);
        }
        setProgress(90,'æ­£åœ¨æ‰“åŒ…å‹ç¼©â€¦');
        const zipBlob = await zip.generateAsync({ type:'blob' }, m=>{
          const extra = Math.round((m.percent||0)*0.1);
          setProgress(90+extra, `å‹ç¼©ä¸­â€¦ ${Math.round(m.percent||0)}%`);
        });
        setProgress(100,'å®Œæˆï¼Œå‡†å¤‡ä¸‹è½½â€¦');
        saveAs(zipBlob, 'ä¸ªäººè‰²å½©ï¼ˆå­£èŠ‚å‹&è„¸å‹ï¼‰æŠ¥å‘Š.zip');
      } catch(err){
        console.error(err);
        alert('ç”Ÿæˆè¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜ï¼š' + (err && err.message ? err.message : err));
      } finally {
        setTimeout(()=>{ panel.style.display='none'; fill.style.width='0%'; text.textContent=''; }, 1500);
      }
    });

    /* D é”®ï¼šè¾…åŠ©çº¿ */
    window.addEventListener('keydown', e=>{
      if(e.key.toLowerCase()==='d') document.body.classList.toggle('debug-on');
    });
  </script>
</body>
</html>






